<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Dev Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div id="app">Caricamento...</div>

    <script>
        let view = localStorage.getItem('setupDone') ? 'chat' : 'setup';
        let messages = JSON.parse(localStorage.getItem('messages') || '[]');
        let projects = JSON.parse(localStorage.getItem('projects') || '[]');
        let drafts = JSON.parse(localStorage.getItem('drafts') || '[]');
        let showingDrafts = false;
        let savedChats = JSON.parse(localStorage.getItem('savedChats') || '[]');
        let currentChatId = localStorage.getItem('currentChatId') || null;
        let uploadedFiles = [];

        const geminiKey = () => localStorage.getItem('geminiKey') || '';
        const githubToken = () => localStorage.getItem('githubToken') || '';

        function render() {
            const app = document.getElementById('app');
            
            if (view === 'setup') {
                app.innerHTML = '<div class="min-h-screen bg-gradient-to-br from-purple-900 to-indigo-900 p-4 flex items-center justify-center"><div class="max-w-md w-full bg-white rounded-lg shadow-2xl p-6"><h1 class="text-3xl font-bold text-center mb-6 text-gray-800">Setup</h1><div class="mb-4"><label class="block font-bold mb-2">Gemini API Key</label><input type="text" id="geminiKey" value="' + geminiKey() + '" class="w-full p-3 border rounded"></div><div class="mb-6"><label class="block font-bold mb-2">GitHub Token</label><input type="text" id="githubToken" value="' + githubToken() + '" class="w-full p-3 border rounded"></div><button onclick="saveSetup()" class="w-full bg-indigo-600 text-white p-3 rounded font-bold">Salva</button></div></div>';
            } else {
                let content = '';
                if (view === 'chat') content = renderChat();
                else if (view === 'chats') content = renderChats();
                else content = renderProjects();
                
                app.innerHTML = '<nav class="bg-indigo-600 text-white p-4"><div class="flex justify-between items-center"><h1 class="text-xl font-bold">AI Dev</h1><div class="flex gap-2"><button onclick="changeView(\'chat\')" class="px-4 py-2 rounded ' + (view==='chat'?'bg-indigo-800':'bg-indigo-700') + '">Chat</button><button onclick="changeView(\'chats\')" class="px-4 py-2 rounded ' + (view==='chats'?'bg-indigo-800':'bg-indigo-700') + '">Chats</button><button onclick="changeView(\'projects\')" class="px-4 py-2 rounded ' + (view==='projects'?'bg-indigo-800':'bg-indigo-700') + '">Progetti</button><button onclick="changeView(\'setup\')" class="px-4 py-2 rounded bg-indigo-700">Setup</button></div></div></nav><div class="max-w-4xl mx-auto p-4">' + content + '</div>';
            }
        }

        function renderChat() {
            let html = '<div class="bg-white rounded-lg shadow-lg p-4 mb-4" style="height:60vh;overflow-y:auto" id="chatBox">';
            if (messages.length === 0) {
                html += '<div class="text-center text-gray-500 mt-20"><p class="text-4xl mb-4">üëã</p><p class="text-xl">Chatta con Gemini!</p></div>';
            } else {
                for (let i = 0; i < messages.length; i++) {
                    const msg = messages[i];
                    let content = msg.content;
                    if (msg.role === 'assistant' && content.indexOf('```') > -1) {
                        content = content.replace(/```[\s\S]*?```/g, '').trim() || 'Codice generato';
                    }
                    html += '<div class="mb-4 ' + (msg.role==='user'?'text-right':'text-left') + '"><div class="inline-block p-3 rounded-lg max-w-md ' + (msg.role==='user'?'bg-indigo-600 text-white':'bg-gray-200') + '"><pre class="whitespace-pre-wrap text-sm">' + escapeHtml(content) + '</pre></div></div>';
                }
            }
            html += '</div><div class="mb-4"><textarea id="chatInput" placeholder="Messaggio..." class="w-full p-3 border rounded resize-none" rows="4"></textarea><div class="flex gap-2 mt-2"><input type="file" id="fileInput" multiple accept="image/*,.txt,.pdf,.doc,.docx,.json,.csv" style="display:none"><button onclick="openFileInput()" class="bg-gray-600 text-white px-4 py-3 rounded font-semibold">üìé</button><button onclick="sendMessage()" class="flex-1 bg-indigo-600 text-white py-3 rounded font-semibold">Invia</button>';
            if (messages.length > 0) {
                html += '<button onclick="clearChat()" class="flex-1 bg-red-600 text-white py-3 rounded font-semibold">Cancella</button>';
            }
            html += '</div>';
            if (uploadedFiles.length > 0) {
                html += '<div class="mt-2 flex flex-wrap gap-2">';
                for (let i = 0; i < uploadedFiles.length; i++) {
                    html += '<div class="bg-gray-200 px-3 py-1 rounded text-sm flex items-center gap-2"><span>' + escapeHtml(uploadedFiles[i].name) + '</span><button onclick="removeFile(' + i + ')" class="text-red-600 font-bold">√ó</button></div>';
                }
                html += '</div>';
            }
            html += '</div>';
            
            let hasCodeInHistory = false;
            for (let i = messages.length - 1; i >= 0; i--) {
                if (messages[i].role === 'assistant' && messages[i].content.indexOf('```html') > -1) {
                    hasCodeInHistory = true;
                    break;
                }
            }
            
            if (messages.length > 0 && hasCodeInHistory) {
                html += '<div class="grid grid-cols-2 gap-2 mb-2"><button onclick="previewCode()" class="bg-purple-600 text-white p-3 rounded font-semibold">Preview</button><button onclick="viewLastCode()" class="bg-gray-700 text-white p-3 rounded font-semibold">Codice</button></div><div class="grid grid-cols-3 gap-2 mb-2"><button onclick="saveDraft()" class="bg-blue-600 text-white p-3 rounded font-semibold">Bozza</button><button onclick="createRepo()" class="bg-green-600 text-white p-3 rounded font-semibold">Repo</button><button onclick="generateAPK()" class="bg-orange-600 text-white p-3 rounded font-semibold">APK</button></div><div class="grid grid-cols-2 gap-2"><button onclick="saveChat()" class="bg-yellow-600 text-white p-3 rounded font-semibold">Salva Chat</button><button onclick="newChat()" class="bg-teal-600 text-white p-3 rounded font-semibold">Nuova Chat</button></div>';
            } else if (messages.length > 0) {
                html += '<div class="grid grid-cols-2 gap-2"><button onclick="saveChat()" class="bg-yellow-600 text-white p-3 rounded font-semibold">Salva Chat</button><button onclick="newChat()" class="bg-teal-600 text-white p-3 rounded font-semibold">Nuova Chat</button></div>';
            }
            return html;
        }

        function renderChats() {
            let html = '<div class="mb-4"><button onclick="newChat()" class="w-full bg-teal-600 text-white p-3 rounded font-semibold">Nuova Chat</button></div>';
            if (savedChats.length === 0) {
                html += '<div class="bg-white p-12 rounded-lg shadow text-center"><p class="text-6xl mb-4">üí¨</p><p class="text-xl">Nessuna chat salvata</p></div>';
            } else {
                for (let i = 0; i < savedChats.length; i++) {
                    const chat = savedChats[i];
                    const date = new Date(chat.timestamp).toLocaleString('it-IT');
                    const preview = chat.messages.length > 0 ? chat.messages[0].content.substring(0, 50) + '...' : 'Chat vuota';
                    html += '<div class="bg-white p-4 rounded-lg shadow mb-4"><h3 class="font-bold mb-2">' + escapeHtml(chat.name) + '</h3><p class="text-sm text-gray-600 mb-2">' + date + ' - ' + chat.messages.length + ' messaggi</p><p class="text-sm text-gray-500 mb-3">' + escapeHtml(preview) + '</p><div class="flex gap-3 text-sm"><button onclick="loadChat(' + i + ')" class="text-blue-600 font-semibold">Apri</button><button onclick="renameChat(' + i + ')" class="text-green-600">Rinomina</button><button onclick="deleteChat(' + i + ')" class="text-red-600">Elimina</button></div></div>';
                }
            }
            return html;
        }

        function renderProjects() {
            const list = showingDrafts ? drafts : projects;
            let html = '<div class="mb-4 flex gap-2"><button onclick="toggleDrafts(false)" class="flex-1 px-4 py-2 rounded ' + (showingDrafts?'bg-gray-200':'bg-indigo-600 text-white') + '">Repository</button><button onclick="toggleDrafts(true)" class="flex-1 px-4 py-2 rounded ' + (showingDrafts?'bg-indigo-600 text-white':'bg-gray-200') + '">Bozze</button></div>';
            if (list.length === 0) {
                html += '<div class="bg-white p-12 rounded-lg shadow text-center"><p class="text-6xl mb-4">' + (showingDrafts?'üìù':'üì≠') + '</p><p class="text-xl">Nessun elemento</p></div>';
            } else {
                for (let i = 0; i < list.length; i++) {
                    const item = list[i];
                    html += '<div class="bg-white p-4 rounded-lg shadow mb-4"><h3 class="font-bold mb-2">' + escapeHtml(item.name) + '</h3>';
                    if (!showingDrafts) html += '<a href="' + item.repoUrl + '" target="_blank" class="text-blue-600 text-sm block mb-2">Apri</a>';
                    html += '<div class="flex gap-3 text-sm"><button onclick="viewCode(' + i + ',' + showingDrafts + ')" class="text-blue-600">Codice</button><button onclick="previewItem(' + i + ',' + showingDrafts + ')" class="text-purple-600">Preview</button>';
                    if (!showingDrafts) html += '<button onclick="generateProjectAPK(' + i + ')" class="text-orange-600">APK</button>';
                    else html += '<button onclick="promoteDraft(' + i + ')" class="text-green-600">Crea Repo</button>';
                    html += '<button onclick="deleteItem(' + i + ',' + showingDrafts + ')" class="text-red-600">Elimina</button></div></div>';
                }
            }
            return html;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function scrollToBottom() {
            setTimeout(function() {
                const box = document.getElementById('chatBox');
                if (box) box.scrollTop = box.scrollHeight;
            }, 100);
        }

        window.saveSetup = function() {
            const gKey = document.getElementById('geminiKey').value;
            const ghToken = document.getElementById('githubToken').value;
            if (!gKey || !ghToken) { alert('Compila i campi!'); return; }
            localStorage.setItem('geminiKey', gKey);
            localStorage.setItem('githubToken', ghToken);
            localStorage.setItem('setupDone', 'true');
            view = 'chat';
            render();
        };

        window.changeView = function(newView) {
            view = newView;
            render();
            if (newView === 'chat') scrollToBottom();
        };

        window.toggleDrafts = function(show) {
            showingDrafts = show;
            render();
        };

        window.sendMessage = async function() {
            const inputEl = document.getElementById('chatInput');
            if (!inputEl) return;
            const text = inputEl.value.trim();
            if (!text && uploadedFiles.length === 0) return;
            const gKey = geminiKey();
            if (!gKey) { alert('Configura Gemini Key!'); return; }
            
            let userMessage = text;
            if (uploadedFiles.length > 0) {
                userMessage += '\n\n[File allegati: ' + uploadedFiles.map(function(f) { return f.name; }).join(', ') + ']';
            }
            
            messages.push({ role: 'user', content: userMessage, timestamp: Date.now() });
            localStorage.setItem('messages', JSON.stringify(messages));
            inputEl.value = '';
            render();
            scrollToBottom();
            
            try {
                const history = messages.slice(-40).map(function(m) {
                    return { role: m.role==='user'?'user':'model', parts: [{ text: m.content }] };
                });
                
                if (uploadedFiles.length > 0) {
                    const lastMsg = history[history.length - 1];
                    lastMsg.parts = [];
                    if (text) lastMsg.parts.push({ text: text });
                    
                    for (let i = 0; i < uploadedFiles.length; i++) {
                        const file = uploadedFiles[i];
                        if (file.type.startsWith('image/')) {
                            lastMsg.parts.push({
                                inline_data: {
                                    mime_type: file.type,
                                    data: file.data
                                }
                            });
                        } else {
                            lastMsg.parts.push({
                                text: '\n\nContenuto file ' + file.name + ':\n' + file.content
                            });
                        }
                    }
                }
                
                const sys = { role: 'user', parts: [{ text: "Sei un assistente AI esperto in sviluppo web, PWA e siti. Fornisci codice completo funzionante. Ogni app self-contained in HTML con CSS e JS inline. Usa HTML5, CSS3, JavaScript ES6+. Design responsive mobile-first. Codice pulito con best practices. Solo implementazioni concrete. Genera codice in blocchi markdown html. Usa Tailwind CDN o CSS inline. Web app interattive, Dashboard, Landing page, PWA, localStorage, Design moderni, UI intuitive. Analizza tecnicamente, implementa soluzioni robuste, codice production-ready. Precisione assoluta." }] };
                const res = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=' + gKey, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [sys].concat(history), generationConfig: { temperature: 0.3, maxOutputTokens: 8192, topP: 0.9, topK: 40 } })
                });
                const data = await res.json();
                const aiText = data.candidates[0].content.parts[0].text || 'Errore';
                messages.push({ role: 'assistant', content: aiText, timestamp: Date.now() });
                localStorage.setItem('messages', JSON.stringify(messages));
                uploadedFiles = [];
            } catch (error) {
                messages.push({ role: 'assistant', content: 'Errore: ' + error.message, timestamp: Date.now() });
                localStorage.setItem('messages', JSON.stringify(messages));
                uploadedFiles = [];
            }
            render();
            scrollToBottom();
        };

        window.clearChat = function() {
            if (confirm('Cancellare cronologia?')) {
                messages = [];
                localStorage.setItem('messages', JSON.stringify(messages));
                render();
            }
        };

        window.saveDraft = function() {
            const name = prompt('Nome bozza:');
            if (!name) return;
            
            for (let i = messages.length - 1; i >= 0; i--) {
                if (messages[i].role === 'assistant' && messages[i].content.indexOf('```html') > -1) {
                    drafts.unshift({ name: name, code: messages[i].content, createdAt: Date.now() });
                    localStorage.setItem('drafts', JSON.stringify(drafts));
                    alert('Salvata!');
                    return;
                }
            }
            
            drafts.unshift({ name: name, code: messages[messages.length-1].content, createdAt: Date.now() });
            localStorage.setItem('drafts', JSON.stringify(drafts));
            alert('Salvata!');
        };

        window.createRepo = async function() {
            const name = prompt('Nome repo:');
            if (!name) return;
            const token = githubToken();
            if (!token) { alert('Token mancante!'); return; }
            
            let code = '';
            for (let i = messages.length - 1; i >= 0; i--) {
                if (messages[i].role === 'assistant') {
                    const match = messages[i].content.match(/```html\n([\s\S]*?)\n```/);
                    if (match) {
                        code = match[1];
                        break;
                    }
                }
            }
            
            if (!code) {
                alert('Nessun codice HTML trovato!');
                return;
            }
            
            try {
                const res = await fetch('https://api.github.com/user/repos', {
                    method: 'POST',
                    headers: { 'Authorization': 'token ' + token, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name, description: 'AI Dev', private: false, auto_init: true })
                });
                const repo = await res.json();
                if (repo.html_url) {
                    projects.unshift({ name: name, repoUrl: repo.html_url, code: code, createdAt: Date.now() });
                    localStorage.setItem('projects', JSON.stringify(projects));
                    try { await navigator.clipboard.writeText(code); alert('Repo creata! Codice copiato!'); } catch(e) { alert('Repo creata!'); }
                    if (confirm('Aprire GitHub?')) window.open('https://github.com/' + repo.full_name + '/new/main', '_blank');
                    view = 'projects';
                    render();
                } else {
                    alert('Errore: ' + (repo.message || 'Errore'));
                }
            } catch (error) {
                alert('Errore: ' + error.message);
            }
        };

        window.previewCode = function() {
            for (let i = messages.length - 1; i >= 0; i--) {
                if (messages[i].role === 'assistant') {
                    const match = messages[i].content.match(/```html\n([\s\S]*?)\n```/) || messages[i].content.match(/```html([\s\S]*?)```/);
                    if (match) {
                        const w = window.open('', '_blank');
                        w.document.write(match[1]);
                        w.document.close();
                        return;
                    }
                }
            }
            alert('Nessun codice trovato!');
        };

        window.viewLastCode = function() {
            for (let i = messages.length - 1; i >= 0; i--) {
                if (messages[i].role === 'assistant') {
                    const match = messages[i].content.match(/```html\n([\s\S]*?)\n```/) || messages[i].content.match(/```html([\s\S]*?)```/);
                    if (match) {
                        const code = match[1];
                        const w = window.open('', '_blank');
                        w.document.write('<html><head><meta charset="UTF-8"><style>body{margin:0;padding:20px;font-family:monospace;background:#1e1e1e;color:#d4d4d4}pre{white-space:pre-wrap;background:#2d2d2d;padding:20px;border-radius:8px}button{background:#007acc;color:white;border:none;padding:10px 20px;border-radius:4px;margin-right:10px;margin-bottom:20px}</style></head><body><button onclick="navigator.clipboard.writeText(document.getElementById(\'c\').textContent).then(function(){alert(\'Copiato!\')})">Copia</button><button onclick="window.close()">Chiudi</button><pre id="c">' + escapeHtml(code) + '</pre></body></html>');
                        w.document.close();
                        return;
                    }
                }
            }
            alert('Nessun codice trovato!');
        };

        window.previewItem = function(i, isDraft) {
            const item = (isDraft ? drafts : projects)[i];
            const match = item.code.match(/```html\n([\s\S]*?)\n```/);
            const w = window.open('', '_blank');
            w.document.write(match ? match[1] : item.code);
            w.document.close();
        };

        window.generateAPK = function() {
            if (confirm('Per APK: Crea Repo, Carica codice, Attiva Pages, Usa APK in Progetti. Creare repo?')) createRepo();
        };

        window.generateProjectAPK = function(i) {
            const match = projects[i].repoUrl.match(/github\.com\/([^\/]+)\/([^\/]+)/);
            if (!match) { alert('URL non valido'); return; }
            const url = 'https://' + match[1] + '.github.io/' + match[2];
            if (confirm('APK - URL: ' + url + '. Aprire PWABuilder?')) window.open('https://www.pwabuilder.com/?site=' + encodeURIComponent(url), '_blank');
        };

        window.viewCode = function(i, isDraft) {
            const item = (isDraft ? drafts : projects)[i];
            if (confirm('Copiare?')) navigator.clipboard.writeText(item.code).then(function(){alert('Copiato!');}).catch(function(){alert('Errore');});
        };

        window.promoteDraft = async function(i) {
            const draft = drafts[i];
            const token = githubToken();
            if (!token) { alert('Token mancante!'); return; }
            try {
                const res = await fetch('https://api.github.com/user/repos', {
                    method: 'POST',
                    headers: { 'Authorization': 'token ' + token, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: draft.name, description: 'AI Dev', private: false, auto_init: true })
                });
                const repo = await res.json();
                if (repo.html_url) {
                    projects.unshift({ name: draft.name, repoUrl: repo.html_url, code: draft.code, createdAt: Date.now() });
                    localStorage.setItem('projects', JSON.stringify(projects));
                    try { await navigator.clipboard.writeText(draft.code); } catch(e) {}
                    alert('Repo creata!');
                    showingDrafts = false;
                    render();
                }
            } catch (error) {
                alert('Errore: ' + error.message);
            }
        };

        window.deleteItem = function(i, isDraft) {
            if (confirm('Eliminare?')) {
                (isDraft ? drafts : projects).splice(i, 1);
                localStorage.setItem(isDraft ? 'drafts' : 'projects', JSON.stringify(isDraft ? drafts : projects));
                render();
            }
        };

        window.saveChat = function() {
            if (messages.length === 0) { alert('Nessun messaggio!'); return; }
            let defaultName = 'Chat ' + new Date().toLocaleDateString();
            if (currentChatId) {
                for (let i = 0; i < savedChats.length; i++) {
                    if (savedChats[i].id === currentChatId) {
                        defaultName = savedChats[i].name;
                        break;
                    }
                }
            }
            const name = prompt('Nome chat:', defaultName);
            if (!name) return;
            const chatData = { id: currentChatId || Date.now().toString(), name: name, messages: messages, timestamp: Date.now() };
            if (currentChatId) {
                let found = false;
                for (let i = 0; i < savedChats.length; i++) {
                    if (savedChats[i].id === currentChatId) {
                        savedChats[i] = chatData;
                        found = true;
                        break;
                    }
                }
                if (!found) savedChats.unshift(chatData);
            } else {
                savedChats.unshift(chatData);
                currentChatId = chatData.id;
                localStorage.setItem('currentChatId', currentChatId);
            }
            localStorage.setItem('savedChats', JSON.stringify(savedChats));
            alert('Chat salvata!');
        };

        window.newChat = function() {
            if (messages.length > 0 && !confirm('Nuova chat? La chat corrente NON sara salvata automaticamente.')) return;
            messages = [];
            currentChatId = null;
            localStorage.setItem('messages', '[]');
            localStorage.removeItem('currentChatId');
            view = 'chat';
            render();
        };

        window.loadChat = function(i) {
            const chat = savedChats[i];
            messages = JSON.parse(JSON.stringify(chat.messages));
            currentChatId = chat.id;
            localStorage.setItem('messages', JSON.stringify(messages));
            localStorage.setItem('currentChatId', currentChatId);
            view = 'chat';
            render();
        };

        window.renameChat = function(i) {
            const newName = prompt('Nuovo nome:', savedChats[i].name);
            if (!newName) return;
            savedChats[i].name = newName;
            localStorage.setItem('savedChats', JSON.stringify(savedChats));
            render();
        };

        window.deleteChat = function(i) {
            if (!confirm('Eliminare?')) return;
            const deletedId = savedChats[i].id;
            savedChats.splice(i, 1);
            localStorage.setItem('savedChats', JSON.stringify(savedChats));
            if (currentChatId === deletedId) {
                messages = [];
                currentChatId = null;
                localStorage.setItem('messages', '[]');
                localStorage.removeItem('currentChatId');
            }
            render();
        };

        window.handleFileUpload = async function(event) {
            const files = event.target.files;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.size > 5 * 1024 * 1024) {
                    alert('File troppo grande: ' + file.name + ' (max 5MB)');
                    continue;
                }
                
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const base64 = e.target.result.split(',')[1];
                        uploadedFiles.push({
                            name: file.name,
                            type: file.type,
                            data: base64
                        });
                        render();
                    };
                    reader.readAsDataURL(file);
                } else {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        uploadedFiles.push({
                            name: file.name,
                            type: file.type,
                            content: e.target.result
                        });
                        render();
                    };
                    reader.readAsText(file);
                }
            }
            event.target.value = '';
        };

        window.openFileInput = function() {
            const input = document.getElementById('fileInput');
            if (input) {
                input.onchange = handleFileUpload;
                input.click();
            }
        };

        window.removeFile = function(i) {
            uploadedFiles.splice(i, 1);
            render();
        };

        render();
    </script>
</body>
</html>